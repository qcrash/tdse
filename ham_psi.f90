subroutine ham_psi(n, h, psi, Hpsi)
!------------------------------------------------------------------------------
! Description:
!------------------------------------------------------------------------------
! Quickly compute H applied to psi given n and h.
!------------------------------------------------------------------------------
  implicit none
!------------------------------------------------------------------------------
! Modules and Global Variables
!------------------------------------------------------------------------------

!------------------------------------------------------------------------------
! External Functions
!------------------------------------------------------------------------------

!------------------------------------------------------------------------------
! Input Parameters
!------------------------------------------------------------------------------
  integer, intent(in) :: n
  double precision, intent(in) :: h
  double complex, intent(in) :: psi(n)
!------------------------------------------------------------------------------
! Output Parameters
!------------------------------------------------------------------------------
  double complex, intent(out) :: Hpsi(n)
!------------------------------------------------------------------------------
! Input/Output Parameters
!------------------------------------------------------------------------------

!------------------------------------------------------------------------------
!  Local Variables
!------------------------------------------------------------------------------
  integer :: igrid
!------------------------------------------------------------------------------
!  Local Constants 
!------------------------------------------------------------------------------
  ! second derivative loop
  do igrid = 3, n-2
     Hpsi(igrid) = -(psi(igrid-2) - 2d0*psi(igrid) + psi(igrid+2))
     ! -d2/dx^2 psi => Hpsi
  end do

  ! first and last points special case
  Hpsi(1) = -(-psi(1) + psi(3))
  Hpsi(2) = -(-2d0*psi(2) + psi(4))
  Hpsi(n-1) = -(psi(n-3) - 2d0*psi(n-1))
  Hpsi(n) = -(psi(n-2) - psi(n))

  ! multiply -d2/dx^2 by 1/(2h^2) to get Hpsi
  Hpsi = dcmplx(0.125d0/(h*h),0d0)*Hpsi ! 1/2 from p^2/2 and 1/4 from
  ! central difference formula
end subroutine ham_psi
